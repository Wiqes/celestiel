import{a as D,d as j}from"./chunk-LWFHABSB.js";import{f as I}from"./chunk-K5BU6CYA.js";import{c as y}from"./chunk-OHSBJFGJ.js";import{C as T,Ka as p,w as x}from"./chunk-ZXNNLAB3.js";import{A as d,D as m,E as v,M as k,O as w,R as a,X as i,h as f,l as u,p as h,sa as S,wa as b,z as g}from"./chunk-QP7WRVZV.js";var c=class r{platformId=i(b);getFingerprint(){if(!x(this.platformId))return btoa("server-side-fallback");let e=this.getPlatform(),t=[navigator.userAgent,navigator.language,screen.width+"x"+screen.height,new Date().getTimezoneOffset(),e].join("|");return btoa(t)}getPlatform(){if("userAgentData"in navigator){let t=navigator.userAgentData;if(t?.platform)return t.platform}let e=navigator.userAgent.toLowerCase();return e.includes("windows")?"Windows":e.includes("mac")?"macOS":e.includes("linux")?"Linux":e.includes("android")?"Android":e.includes("iphone")||e.includes("ipad")?"iOS":"Unknown"}static \u0275fac=function(t){return new(t||r)};static \u0275prov=a({token:r,factory:r.\u0275fac,providedIn:"root"})};var o=class extends Error{};o.prototype.name="InvalidTokenError";function R(r){return decodeURIComponent(atob(r).replace(/(.)/g,(e,t)=>{let n=t.charCodeAt(0).toString(16).toUpperCase();return n.length<2&&(n="0"+n),"%"+n}))}function U(r){let e=r.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return R(e)}catch{return atob(e)}}function A(r,e){if(typeof r!="string")throw new o("Invalid token specified: must be a string");e||(e={});let t=e.header===!0?0:1,n=r.split(".")[t];if(typeof n!="string")throw new o(`Invalid token specified: missing part #${t+1}`);let s;try{s=U(n)}catch(l){throw new o(`Invalid token specified: invalid base64 for part #${t+1} (${l.message})`)}try{return JSON.parse(s)}catch(l){throw new o(`Invalid token specified: invalid json for part #${t+1} (${l.message})`)}}var E=class r{router=i(I);stateService=i(y);chatStateService=i(D);chatService=i(j);fingerprintService=i(c);http=i(T);isLoggedIn=S(!1);isRefreshing=new u(!1);refreshTokenSubject=new u(null);logout(){this.stateService.isDataLoading.set(!0);let e=this.getToken(),t=e?{headers:{Authorization:`Bearer ${e}`}}:{};this.http.post(`${p.API_URL}/auth/logout`,{},t).subscribe({next:()=>{this.isRefreshing.next(!1),this.refreshTokenSubject.next(null),this.moveToLogin()},error:()=>{this.moveToLogin()}})}moveToLogin(){this.isLoggedIn.set(!1),window.localStorage.removeItem("token"),this.stateService.user.set(null),this.stateService.tokenProfile.set(null),this.chatStateService.chats.set(null),this.router.navigateByUrl("/",{replaceUrl:!0}).finally(()=>{this.stateService.isDataLoading.set(!1)})}getToken(){try{return window.localStorage.getItem("token")}catch{return null}}getTokenExpiration(){let e=this.getToken();if(!e)return null;try{return A(e).exp||null}catch(t){return console.error("Error decoding token:",t),null}}getTokenExpirationInfo(){let e=this.getTokenExpiration();if(!e)return{expired:!0,expiresAt:null,timeUntilExpiry:null};let t=Math.floor(Date.now()/1e3),n=new Date(e*1e3),s=e-t;return{expired:t>=e,expiresAt:n,timeUntilExpiry:s}}isTokenExpiringSoon(e=60){let t=this.getTokenExpiration();return t?Math.floor(Date.now()/1e3)+e>=t:!0}getFingerprint(){return this.fingerprintService.getFingerprint()}refreshToken(){if(this.isRefreshing.value)return this.refreshTokenSubject.pipe(g(t=>t!==null),m(1));this.isRefreshing.next(!0),this.refreshTokenSubject.next(null);let e=this.getFingerprint();return this.http.post(`${p.API_URL}/auth/refresh`,{fingerprint:e},{withCredentials:!0}).pipe(w(t=>{this.onRefreshSuccess(t),this.refreshTokenSubject.next(t.access_token)}),k(t=>new f(n=>{n.next(t.access_token),n.complete()})),d(t=>(this.refreshTokenSubject.next(null),this.moveToLogin(),h(()=>t))),v(()=>{this.isRefreshing.next(!1)}))}onRefreshSuccess(e){let t=e?.access_token||null;if(t){try{window.localStorage.setItem("token",e.access_token)}catch(n){console.error("Error saving token:",n)}this.chatService.isUserAuthenticated()||(console.log("Reconnecting chat service after token refresh"),this.chatService.disconnect(),this.chatService.connect(t))}}static \u0275fac=function(t){return new(t||r)};static \u0275prov=a({token:r,factory:r.\u0275fac,providedIn:"root"})};export{c as a,A as b,E as c};
