import{a as C,d as U}from"./chunk-2TC66BOA.js";import{a as E,b as R}from"./chunk-67XSK42V.js";import{f as l}from"./chunk-K5BU6CYA.js";import{a as f,c as F}from"./chunk-WUSS4SHQ.js";import{C as h,Ka as u,w as j}from"./chunk-ZXNNLAB3.js";import{A as b,D as x,E as I,M as w,O as y,R as a,X as n,ga as A,h as v,l as S,p as k,sa as D,tc as g,wa as L,z as T}from"./chunk-QP7WRVZV.js";var c=class r{platformId=n(L);getFingerprint(){if(!j(this.platformId))return btoa("server-side-fallback");let e=this.getPlatform(),t=[navigator.userAgent,navigator.language,screen.width+"x"+screen.height,new Date().getTimezoneOffset(),e].join("|");return btoa(t)}getPlatform(){if("userAgentData"in navigator){let t=navigator.userAgentData;if(t?.platform)return t.platform}let e=navigator.userAgent.toLowerCase();return e.includes("windows")?"Windows":e.includes("mac")?"macOS":e.includes("linux")?"Linux":e.includes("android")?"Android":e.includes("iphone")||e.includes("ipad")?"iOS":"Unknown"}static \u0275fac=function(t){return new(t||r)};static \u0275prov=a({token:r,factory:r.\u0275fac,providedIn:"root"})};var s=class extends Error{};s.prototype.name="InvalidTokenError";function q(r){return decodeURIComponent(atob(r).replace(/(.)/g,(e,t)=>{let i=t.charCodeAt(0).toString(16).toUpperCase();return i.length<2&&(i="0"+i),"%"+i}))}function B(r){let e=r.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return q(e)}catch{return atob(e)}}function M(r,e){if(typeof r!="string")throw new s("Invalid token specified: must be a string");e||(e={});let t=e.header===!0?0:1,i=r.split(".")[t];if(typeof i!="string")throw new s(`Invalid token specified: missing part #${t+1}`);let o;try{o=B(i)}catch(p){throw new s(`Invalid token specified: invalid base64 for part #${t+1} (${p.message})`)}try{return JSON.parse(o)}catch(p){throw new s(`Invalid token specified: invalid json for part #${t+1} (${p.message})`)}}var d=class r{router=n(l);stateService=n(F);chatStateService=n(C);authTokenStateService=n(f);chatService=n(U);fingerprintService=n(c);http=n(h);token=g(()=>this.authTokenStateService.token());isRefreshing=g(()=>this.authTokenStateService.isRefreshing());refreshTokenSubject=new S(null);logout(){this.stateService.isDataLoading.set(!0);let e=this.token(),t=e?{headers:{Authorization:`Bearer ${e}`}}:{};this.http.post(`${u.API_URL}/auth/logout`,{},t).subscribe({next:()=>{this.authTokenStateService.isRefreshing.set(!1),this.refreshTokenSubject.next(null),this.moveToLogin()},error:()=>{this.moveToLogin()}})}moveToLogin(){this.authTokenStateService.token.set(null),this.stateService.user.set(null),this.stateService.tokenProfile.set(null),this.chatStateService.chats.set(null),this.router.navigateByUrl("/",{replaceUrl:!0}).finally(()=>{this.stateService.isDataLoading.set(!1)})}getTokenExpiration(){let e=this.token();if(!e)return null;try{return M(e).exp||null}catch(t){return console.error("Error decoding token:",t),null}}getTokenExpirationInfo(){let e=this.getTokenExpiration();if(!e)return{expired:!0,expiresAt:null,timeUntilExpiry:null};let t=Math.floor(Date.now()/1e3),i=new Date(e*1e3),o=e-t;return{expired:t>=e,expiresAt:i,timeUntilExpiry:o}}isTokenExpiringSoon(e=60){let t=this.getTokenExpiration();return t?Math.floor(Date.now()/1e3)+e>=t:!0}getFingerprint(){return this.fingerprintService.getFingerprint()}refreshToken(){if(this.isRefreshing())return this.refreshTokenSubject.pipe(T(t=>t!==null),x(1));this.authTokenStateService.isRefreshing.set(!0),this.refreshTokenSubject.next(null);let e=this.getFingerprint();return this.http.post(`${u.API_URL}/auth/refresh`,{fingerprint:e},{withCredentials:!0}).pipe(y(t=>{this.onRefreshSuccess(t),this.refreshTokenSubject.next(t.access_token)}),w(t=>new v(i=>{i.next(t.access_token),i.complete()})),b(t=>(this.refreshTokenSubject.next(null),this.moveToLogin(),k(()=>t))),I(()=>{this.authTokenStateService.isRefreshing.set(!1)}))}onRefreshSuccess(e){let t=e?.access_token||null;t&&(this.authTokenStateService.token.set(t),this.chatService.isUserAuthenticated()||(console.log("Reconnecting chat service after token refresh"),this.chatService.disconnect(),this.chatService.connect(t)))}static \u0275fac=function(t){return new(t||r)};static \u0275prov=a({token:r,factory:r.\u0275fac,providedIn:"root"})};var m=class{http=n(h);messageService=n(R);isLoading=D(!1);makeAuthRequest(e,t,i,o,p=!0){this.isLoading.set(!0),this.http.post(`${u.API_URL}${e}`,t).subscribe({next:P=>{i(P),p&&this.isLoading.set(!1)},error:()=>{o(),this.isLoading.set(!1)}})}handleSuccess(e,t){e&&this.messageService.sendMessage(e),t&&t()}handleError(e){e&&this.messageService.sendMessage(e)}};var O=class r extends m{router=n(l);authTokenService=n(d);authTokenStateService=n(f);fingerprintService=n(c);getFingerprint(){return this.fingerprintService.getFingerprint()}request({email:e,password:t}){let i=this.getFingerprint();this.makeAuthRequest("/auth/login",{username:e,password:t,fingerprint:i},o=>this.onLoginSuccess(o),()=>this.handleError(E.LOGIN_FAILED),!1)}onLoginSuccess(e){e?.access_token?this.authTokenStateService.token.set(e.access_token):this.authTokenStateService.token.set(null),this.handleSuccess(null,()=>{setTimeout(()=>{this.router.navigate(["/home"]),this.isLoading.set(!1)},800)})}logout(){this.authTokenService.logout()}static \u0275fac=(()=>{let e;return function(i){return(e||(e=A(r)))(i||r)}})();static \u0275prov=a({token:r,factory:r.\u0275fac,providedIn:"root"})};export{m as a,c as b,M as c,d,O as e};
