import{a as p}from"./chunk-4OIULTP7.js";import{c as l,d as f}from"./chunk-6FWNO772.js";import{a as u,b as g}from"./chunk-IOFKV53E.js";import{a as b}from"./chunk-BXKN7MOM.js";import{T as r,Z as i,a as h,b as v,ua as o,xc as m,yc as d}from"./chunk-RFBIJB72.js";var n=class s{interlocutor=o(null);changeOnlineStatus(e,t){let c=this.interlocutor();c&&c.id===e&&this.interlocutor.set(v(h({},c),{isOnline:t}))}static \u0275fac=function(t){return new(t||s)};static \u0275prov=r({token:s,factory:s.\u0275fac,providedIn:"root"})};var a={INVALID_TOKEN:"Invalid token provided for socket",NO_TOKEN:"No token provided for socket",TOKEN_IS_EXPIRED:"Token is expired",RATE_LIMIT_EXCEEDED:"Rate limit exceeded"};var k=class s{interlocutorService=i(n);socket=i(p);authTokenService=i(f);chatStateService=i(l);messageService=i(g);authTokenStateService=i(b);token=m(()=>this.authTokenStateService.token());isChatsLoading=o(!1);constructor(){this.subscribeToEvents(),d(()=>{let e=this.token();e&&(this.disconnect(),this.connect(e))})}subscribeToEvents(){this.onUserChats().subscribe(e=>{this.chatStateService.updateChats(e),this.isChatsLoading.set(!1)}),this.onUserOnlineStatus().subscribe(e=>{this.chatStateService.updateUserOnlineStatus(e.userId,e.isOnline),this.interlocutorService.changeOnlineStatus(e.userId,e.isOnline)}),this.onMessageRemoved().subscribe(e=>{this.chatStateService.removeMessageFromChat(e.chatId,e.messageId)}),this.onError().subscribe(e=>{e.message===a.INVALID_TOKEN&&this.authTokenService.refreshToken().subscribe(t=>{this.connect(t)}),e.message===a.RATE_LIMIT_EXCEEDED&&(this.disconnect(),this.authTokenService.logout(),setTimeout(()=>{this.messageService.sendMessage(u.TOO_MANY_REQUESTS)},2e3))}),this.onDisconnect().subscribe(()=>{this.chatStateService.chats.set(null)})}isConnected(){return this.socket.ioSocket.connected}connect(e){this.isConnected()||(e&&(this.socket.ioSocket.auth={token:e}),this.socket.connect())}disconnect(){this.socket.disconnect()}sendMessage(e){this.socket.emit("sendMessage",e)}onReceiveMessage(){return this.socket.fromEvent("receiveMessage")}removeMessage(e){this.socket.emit("removeMessage",{messageId:e})}onMessageRemoved(){return this.socket.fromEvent("messageRemoved")}onUserOnlineStatus(){return this.socket.fromEvent("userOnlineStatus")}joinChat(e,t){return this.socket.emit("joinChat",{participant1Id:e,participant2Id:t}),this.socket.fromEvent("joinChatResponse")}leaveChat(e){this.socket.emit("leaveChat",{chatId:e})}markMessageAsRead(e){this.socket.emit("markMessageAsRead",{chatId:e})}sendTypingIndicator(e,t){this.socket.emit("typing",{chatId:e,isTyping:t})}onUserTyping(){return this.socket.fromEvent("userTyping")}onUserChats(){return this.socket.fromEvent("userChats")}getUserChats(){this.socket.emit("getUserChats")}onPreviousMessages(){return this.socket.fromEvent("previousMessages")}onConnect(){return this.socket.fromEvent("connect")}onDisconnect(){return this.socket.fromEvent("disconnect")}onError(){return this.socket.fromEvent("error")}static \u0275fac=function(t){return new(t||s)};static \u0275prov=r({token:s,factory:s.\u0275fac,providedIn:"root"})};export{n as a,k as b};
