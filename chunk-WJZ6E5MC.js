import{f as U}from"./chunk-B3JJSCHV.js";import{a as R,c as d}from"./chunk-FRLCIZL7.js";import{a as v}from"./chunk-3LSZXHDL.js";import{D as A,x as j}from"./chunk-RV4DTJEM.js";import{$ as a,A as b,Aa as D,B as T,Bc as m,F as w,H as x,P as C,S as y,V as l,a as o,b as c,h as S,l as k,p as I,wa as g}from"./chunk-ICJYLJNU.js";var h=class n{stateService=a(d);draftMessage=g("");chats=g(null);updateDraftMessage(e){this.draftMessage.set(e)}clearDraftMessage(){this.draftMessage.set("")}updateChats(e){this.chats.set(e)}getUnreadCount(e){if(!e)return 0;let t=this.stateService.profile()?.userId;return t?e.participant1Id===Number(t)?e.unreadCount1||0:e.participant2Id===Number(t)&&e.unreadCount2||0:0}markChatAsRead(e){let i=this.chats()?.map(s=>{if(s.id===e){let r=this.stateService.profile()?.userId;if(!r)return s;if(s.participant1Id===Number(r))return c(o({},s),{unreadCount1:0});if(s.participant2Id===Number(r))return c(o({},s),{unreadCount2:0})}return s})||[];this.chats.set(i)}getChatById(e){return this.chats()?.find(t=>t.id===e)}getChatByParticipantId(e){return this.chats()?.find(t=>t.participant1Id.toString()===e||t.participant2Id.toString()===e)}updateChatLastMessage(e,t){let s=this.chats()?.map(r=>r.id===e?c(o({},r),{lastMessageAt:t}):r)||[];this.chats.set(s)}updateUserOnlineStatus(e,t){let i=this.chats();if(!i?.length)return;let s=i?.map(r=>{let u=o({},r);return r.participant1&&r.participant1.id===e&&(u=c(o({},u),{participant1:c(o({},r.participant1),{isOnline:t})})),r.participant2&&r.participant2.id===e&&(u=c(o({},u),{participant2:c(o({},r.participant2),{isOnline:t})})),u})||[];this.chats.set(s)}removeMessageFromChat(e,t){let i=this.chats();if(!i?.length)return;let s=i.map(r=>r.id===e?c(o({},r),{messages:r.messages.filter(u=>String(u.muid)!==String(t))}):r);console.log("updatedChats",s),this.chats.set(s)}clearChats(){this.chats.set([])}static \u0275fac=function(t){return new(t||n)};static \u0275prov=l({token:n,factory:n.\u0275fac,providedIn:"root"})};var f=class n{platformId=a(D);getFingerprint(){if(!j(this.platformId))return btoa("server-side-fallback");let e=this.getPlatform(),t=[navigator.userAgent,navigator.language,screen.width+"x"+screen.height,new Date().getTimezoneOffset(),e].join("|");return btoa(t)}getPlatform(){if("userAgentData"in navigator){let t=navigator.userAgentData;if(t?.platform)return t.platform}let e=navigator.userAgent.toLowerCase();return e.includes("windows")?"Windows":e.includes("mac")?"macOS":e.includes("linux")?"Linux":e.includes("android")?"Android":e.includes("iphone")||e.includes("ipad")?"iOS":"Unknown"}static \u0275fac=function(t){return new(t||n)};static \u0275prov=l({token:n,factory:n.\u0275fac,providedIn:"root"})};var p=class extends Error{};p.prototype.name="InvalidTokenError";function F(n){return decodeURIComponent(atob(n).replace(/(.)/g,(e,t)=>{let i=t.charCodeAt(0).toString(16).toUpperCase();return i.length<2&&(i="0"+i),"%"+i}))}function O(n){let e=n.replace(/-/g,"+").replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break;default:throw new Error("base64 string is not of the correct length")}try{return F(e)}catch{return atob(e)}}function L(n,e){if(typeof n!="string")throw new p("Invalid token specified: must be a string");e||(e={});let t=e.header===!0?0:1,i=n.split(".")[t];if(typeof i!="string")throw new p(`Invalid token specified: missing part #${t+1}`);let s;try{s=O(i)}catch(r){throw new p(`Invalid token specified: invalid base64 for part #${t+1} (${r.message})`)}try{return JSON.parse(s)}catch(r){throw new p(`Invalid token specified: invalid json for part #${t+1} (${r.message})`)}}var M=class n{router=a(U);stateService=a(d);chatStateService=a(h);authTokenStateService=a(R);fingerprintService=a(f);http=a(A);token=m(()=>this.authTokenStateService.token());isRefreshing=m(()=>this.authTokenStateService.isRefreshing());refreshTokenSubject=new k(null);logout(){this.stateService.isDataLoading.set(!0);let e=this.token(),t=e?{headers:{Authorization:`Bearer ${e}`}}:{};this.http.post(`${v.API_URL}/auth/logout`,{},t).subscribe({next:()=>{this.authTokenStateService.isRefreshing.set(!1),this.refreshTokenSubject.next(null),this.moveToLogin()},error:()=>{this.moveToLogin()}})}moveToLogin(){this.authTokenStateService.token.set(null),this.stateService.user.set(null),this.stateService.tokenAvatarUrl.set(null),this.stateService.tokenUserId.set(null),this.chatStateService.chats.set(null),this.router.navigateByUrl("/",{replaceUrl:!0}).finally(()=>{this.stateService.isDataLoading.set(!1)})}getTokenExpiration(){let e=this.token();if(!e)return null;try{return L(e).exp||null}catch(t){return console.error("Error decoding token:",t),null}}getTokenExpirationInfo(){let e=this.getTokenExpiration();if(!e)return{expired:!0,expiresAt:null,timeUntilExpiry:null};let t=Math.floor(Date.now()/1e3),i=new Date(e*1e3),s=e-t;return{expired:t>=e,expiresAt:i,timeUntilExpiry:s}}isTokenExpiringSoon(e=60){let t=this.getTokenExpiration();return t?Math.floor(Date.now()/1e3)+e>=t:!0}getFingerprint(){return this.fingerprintService.getFingerprint()}refreshToken(){if(this.isRefreshing())return this.refreshTokenSubject.pipe(b(t=>t!==null),w(1));this.authTokenStateService.isRefreshing.set(!0),this.refreshTokenSubject.next(null);let e=this.getFingerprint();return this.http.post(`${v.API_URL}/auth/refresh`,{fingerprint:e},{withCredentials:!0}).pipe(y(t=>{this.onRefreshSuccess(t),this.refreshTokenSubject.next(t.access_token)}),C(t=>new S(i=>{i.next(t.access_token),i.complete()})),T(t=>(this.refreshTokenSubject.next(null),this.moveToLogin(),I(()=>t))),x(()=>{this.authTokenStateService.isRefreshing.set(!1)}))}onRefreshSuccess(e){let t=e?.access_token||null;t&&this.authTokenStateService.token.set(t)}static \u0275fac=function(t){return new(t||n)};static \u0275prov=l({token:n,factory:n.\u0275fac,providedIn:"root"})};export{f as a,L as b,h as c,M as d};
