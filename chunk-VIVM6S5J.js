import{a as We,b as Qe}from"./chunk-5SCTDSJE.js";import{a as K,b as J}from"./chunk-A5ECIHF3.js";import"./chunk-BUBY6NXF.js";import{c as $}from"./chunk-WJZ6E5MC.js";import{a as ze,b as Ae}from"./chunk-OWORQFBL.js";import"./chunk-MMTMPY5S.js";import{d as Re}from"./chunk-B3JJSCHV.js";import"./chunk-2FG3VDUF.js";import"./chunk-DZJQPGH6.js";import{b as Fe,e as Le,i as je,m as He,o as W}from"./chunk-7GJ4HY2D.js";import"./chunk-CXP32V3A.js";import"./chunk-EWX7K6IX.js";import"./chunk-GGQ7LRWG.js";import"./chunk-GYPFACBC.js";import"./chunk-F2X3VGZZ.js";import{d as Y,e as q,f as U}from"./chunk-IRAVY6HW.js";import{e as Q,f as B}from"./chunk-437DVS75.js";import"./chunk-F5CENG4Z.js";import{c as T,d as P}from"./chunk-NECVIASH.js";import{a as $e}from"./chunk-GKGI26Z6.js";import{a as Ne,c as A}from"./chunk-FRLCIZL7.js";import"./chunk-3LSZXHDL.js";import{Da as Ue,Ea as z,Ha as Ve,Ka as Ee,j as ke,l as De,m as w,q as Be,u as _}from"./chunk-RV4DTJEM.js";import{$ as g,$b as S,Ab as xe,Bc as C,Cc as Oe,Eb as r,Fb as s,Gb as d,Kb as x,Ob as f,Pb as h,Q as j,Ub as R,V as ue,Va as l,Vb as N,W as fe,Wb as F,a as me,ac as D,b as de,bc as oe,dc as Ie,ec as Se,fc as we,gc as Te,ha as p,hb as u,hc as Pe,ia as c,ib as ve,ja as he,k as ge,ka as ne,lb as be,mb as M,nc as b,oc as y,qa as Ce,ta as H,tb as k,ua as I,ub as a,vb as ye,wa as O,wb as _e,xb as Me}from"./chunk-ICJYLJNU.js";function Xe(i,e){i&1&&(r(0,"div",1)(1,"div",2)(2,"span"),S(3),b(4,"translate"),s()(),r(5,"div",3),d(6,"div",4)(7,"div",4)(8,"div",4),s()()),i&2&&(l(3),D(y(4,1,"is typing")))}var G=class i{isVisible=!1;static \u0275fac=function(t){return new(t||i)};static \u0275cmp=u({type:i,selectors:[["app-typing-indicator"]],inputs:{isVisible:"isVisible"},decls:1,vars:1,consts:[["class","typing-indicator",4,"ngIf"],[1,"typing-indicator"],[1,"typing-text"],[1,"typing-dots"],[1,"dot"]],template:function(t,n){t&1&&M(0,Xe,9,3,"div",0),t&2&&a("ngIf",n.isVisible)},dependencies:[_,w,P,T],styles:[".typing-indicator[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.5rem;font-size:.875rem;color:#34f5f5;border-radius:1rem;animation:_ngcontent-%COMP%_fadeIn .3s ease-in-out}.typing-text[_ngcontent-%COMP%]{font-style:italic}.typing-dots[_ngcontent-%COMP%]{display:flex;gap:.2rem;position:relative;top:4px;left:-2px}.dot[_ngcontent-%COMP%]{width:2px;height:2px;border-radius:50%;background-color:#34f5f5;animation:_ngcontent-%COMP%_pulse 1.4s infinite ease-in-out}.dot[_ngcontent-%COMP%]:nth-child(1){animation-delay:-.32s}.dot[_ngcontent-%COMP%]:nth-child(2){animation-delay:-.16s}@keyframes _ngcontent-%COMP%_pulse{0%,80%,to{transform:scale(.5);opacity:.3}40%{transform:scale(1);opacity:1}}@keyframes _ngcontent-%COMP%_fadeIn{0%{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}"]})};var Z=class i{isTyping=I(!1);isOnline=I(!1);interlocutorProfile=I(null);interlocutorName=C(()=>this.interlocutorProfile()?.name||this.interlocutorProfile()?.email||"Unknown");static \u0275fac=function(t){return new(t||i)};static \u0275cmp=u({type:i,selectors:[["app-chat-header"]],inputs:{isTyping:[1,"isTyping"],isOnline:[1,"isOnline"],interlocutorProfile:[1,"interlocutorProfile"]},decls:8,vars:4,consts:[[1,"header-avatar"],[3,"profile"],[1,"status-indicator",3,"isOnline"],[1,"header-info"],[1,"header-name"],[1,"header-status"],[3,"isVisible"]],template:function(t,n){t&1&&(r(0,"div",0),d(1,"app-chat-avatar",1)(2,"app-online-status",2),s(),r(3,"div",3)(4,"div",4),S(5),s(),r(6,"div",5),d(7,"app-typing-indicator",6),s()()),t&2&&(l(),a("profile",n.interlocutorProfile()),l(),a("isOnline",n.isOnline()),l(3),D(n.interlocutorName()),l(2),a("isVisible",n.isTyping()))},dependencies:[We,G,Qe],styles:["[_nghost-%COMP%]{display:flex;flex-direction:row;align-items:center;padding:10px 15px;background:#18181b80;margin:0;border-bottom:1px solid rgba(52,245,221,.1);min-height:60px}[_nghost-%COMP%]   .header-avatar[_ngcontent-%COMP%]{position:relative;display:flex;align-items:center}[_nghost-%COMP%]   .header-avatar[_ngcontent-%COMP%]   .status-indicator[_ngcontent-%COMP%]{position:absolute;bottom:2px;right:2px;z-index:1}[_nghost-%COMP%]   .header-info[_ngcontent-%COMP%]{margin-left:10px;flex-grow:1;display:flex;flex-direction:column;gap:2px}[_nghost-%COMP%]   .header-info[_ngcontent-%COMP%]   .header-name[_ngcontent-%COMP%]{font-weight:900;font-size:20px;line-height:1.2}[_nghost-%COMP%]   .header-info[_ngcontent-%COMP%]   .header-status[_ngcontent-%COMP%]{font-size:12px;color:var(--text-color-secondary);font-weight:400}"]})};var m=[];for(let i=0;i<256;++i)m.push((i+256).toString(16).slice(1));function Ye(i,e=0){return(m[i[e+0]]+m[i[e+1]]+m[i[e+2]]+m[i[e+3]]+"-"+m[i[e+4]]+m[i[e+5]]+"-"+m[i[e+6]]+m[i[e+7]]+"-"+m[i[e+8]]+m[i[e+9]]+"-"+m[i[e+10]]+m[i[e+11]]+m[i[e+12]]+m[i[e+13]]+m[i[e+14]]+m[i[e+15]]).toLowerCase()}var se,Ze=new Uint8Array(16);function ae(){if(!se){if(typeof crypto>"u"||!crypto.getRandomValues)throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");se=crypto.getRandomValues.bind(crypto)}return se(Ze)}var et=typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),le={randomUUID:et};function tt(i,e,t){i=i||{};let n=i.random??i.rng?.()??ae();if(n.length<16)throw new Error("Random bytes length must be >= 16");if(n[6]=n[6]&15|64,n[8]=n[8]&63|128,e){if(t=t||0,t<0||t+16>e.length)throw new RangeError(`UUID byte range ${t}:${t+15} is out of buffer bounds`);for(let o=0;o<16;++o)e[t+o]=n[o];return e}return Ye(n)}function it(i,e,t){return le.randomUUID&&!e&&!i?le.randomUUID():tt(i,e,t)}var pe=it;var nt=["messageInput"],ee=class i{chatService=g(J);chatStateService=g($);stateService=g(A);interlocutorService=g(K);myProfile=C(()=>this.stateService.profile()||null);currentUserId=C(()=>this.stateService.userId()||"");interlocutor=C(()=>this.interlocutorService.interlocutor()||null);interlocutorProfile=C(()=>this.interlocutor()?.profile||null);activeChatId=I("");receiverId=I("");messageSent=H();isTyping=O(!1);newMessageContent="";typingTimeout;previousMessageContent="";messageInput;ngOnInit(){this.newMessageContent=this.chatStateService.draftMessage(),this.previousMessageContent=this.newMessageContent}onSendButtonMouseDown(e){e.preventDefault()}onKeyPress(e){e.key==="Enter"&&(e.preventDefault(),this.sendMessage())}sendMessage(){if(console.log("Attempting to send message:",this.newMessageContent),this.newMessageContent.trim()&&this.currentUserId()&&this.receiverId()){let e=this.newMessageContent.trim(),t=pe();console.log("Sending message:",e),this.isTyping()&&(this.isTyping.set(!1),this.chatService.sendTypingIndicator(this.activeChatId(),!1),this.typingTimeout&&clearTimeout(this.typingTimeout)),this.newMessageContent="",this.previousMessageContent="",this.chatStateService.clearDraftMessage(),this.messageSent.emit({id:"",muid:t,content:e,timestamp:new Date,sender:{id:this.currentUserId(),profile:this.myProfile()},receiver:{id:this.receiverId(),profile:this.interlocutorProfile()}}),this.chatService.sendMessage({content:e,muid:t,senderId:Number(this.currentUserId()),receiverId:Number(this.receiverId())})}}onModelChange(e){this.newMessageContent=e,setTimeout(()=>{let t=this.messageInput.nativeElement;t.scrollHeight>t.clientHeight?this.newMessageContent=this.previousMessageContent:(this.previousMessageContent=this.newMessageContent,this.typingHandler())},0)}typingHandler(){this.chatStateService.updateDraftMessage(this.newMessageContent),this.activeChatId()&&(this.typingTimeout&&clearTimeout(this.typingTimeout),this.isTyping()||(this.isTyping.set(!0),this.chatService.sendTypingIndicator(this.activeChatId(),!0)),this.typingTimeout=setTimeout(()=>{this.isTyping.set(!1),this.chatService.sendTypingIndicator(this.activeChatId(),!1)},1e3))}ngOnDestroy(){this.typingTimeout&&clearTimeout(this.typingTimeout),this.isTyping()&&this.chatService.sendTypingIndicator(this.activeChatId(),!1)}static \u0275fac=function(t){return new(t||i)};static \u0275cmp=u({type:i,selectors:[["app-message-input"]],viewQuery:function(t,n){if(t&1&&R(nt,5),t&2){let o;N(o=F())&&(n.messageInput=o.first)}},inputs:{activeChatId:[1,"activeChatId"],receiverId:[1,"receiverId"]},outputs:{messageSent:"messageSent"},decls:4,vars:4,consts:[["messageInput",""],["rows","1","maxlength","362",3,"ngModelChange","keydown","ngModel","placeholder"],["icon","pi pi-send","tabindex","-1","severity","success",3,"onClick","onMouseDown"]],template:function(t,n){if(t&1){let o=x();r(0,"textarea",1,0),b(2,"translate"),f("ngModelChange",function(E){return p(o),c(n.onModelChange(E))})("keydown",function(E){return p(o),c(n.onKeyPress(E))}),s(),r(3,"p-button",2),f("onClick",function(){return p(o),c(n.sendMessage())})("onMouseDown",function(E){return p(o),c(n.onSendButtonMouseDown(E))}),s()}t&2&&a("ngModel",n.newMessageContent)("placeholder",y(2,2,"Type your message..."))},dependencies:[_,P,T,q,W,Fe,Le,He,je],styles:["[_nghost-%COMP%]{display:flex;padding:4px;background:#18181b6b;gap:10px;align-items:center}[_nghost-%COMP%]   textarea[_ngcontent-%COMP%]{flex-grow:1;padding:4px;resize:none;border:1px solid transparent;border-radius:6px;height:64px;font-family:inherit;font-size:.875rem;background:#0004;transition:border-color .2s ease;overflow:hidden}[_nghost-%COMP%]   textarea[_ngcontent-%COMP%]:focus{outline:none;box-shadow:0 0 0 2px #007bff40}[_nghost-%COMP%]   textarea[_ngcontent-%COMP%]::placeholder{color:#999}[_nghost-%COMP%]     .p-button{height:64px;width:64px;background:radial-gradient(circle at center,#0009 0% 50%,#34f5dd33)!important}"]})};var ot=({dt:i})=>`
.p-progressspinner {
    position: relative;
    margin: 0 auto;
    width: 100px;
    height: 100px;
    display: inline-block;
}

.p-progressspinner::before {
    content: "";
    display: block;
    padding-top: 100%;
}

.p-progressspinner-spin {
    height: 100%;
    transform-origin: center center;
    width: 100%;
    position: absolute;
    top: 0;
    bottom: 0;
    left: 0;
    right: 0;
    margin: auto;
    animation: p-progressspinner-rotate 2s linear infinite;
}

.p-progressspinner-circle {
    stroke-dasharray: 89, 200;
    stroke-dashoffset: 0;
    stroke: ${i("progressspinner.colorOne")};
    animation: p-progressspinner-dash 1.5s ease-in-out infinite, p-progressspinner-color 6s ease-in-out infinite;
    stroke-linecap: round;
}

@keyframes p-progressspinner-rotate {
    100% {
        transform: rotate(360deg);
    }
}
@keyframes p-progressspinner-dash {
    0% {
        stroke-dasharray: 1, 200;
        stroke-dashoffset: 0;
    }
    50% {
        stroke-dasharray: 89, 200;
        stroke-dashoffset: -35px;
    }
    100% {
        stroke-dasharray: 89, 200;
        stroke-dashoffset: -124px;
    }
}
@keyframes p-progressspinner-color {
    100%,
    0% {
        stroke: ${i("progressspinner.colorOne")};
    }
    40% {
        stroke: ${i("progressspinner.colorTwo")};
    }
    66% {
        stroke: ${i("progressspinner.colorThree")};
    }
    80%,
    90% {
        stroke: ${i("progressspinner.colorFour")};
    }
}
`,rt={root:"p-progressspinner",spin:"p-progressspinner-spin",circle:"p-progressspinner-circle"},qe=(()=>{class i extends Ve{name="progressspinner";theme=ot;classes=rt;static \u0275fac=(()=>{let t;return function(o){return(t||(t=ne(i)))(o||i)}})();static \u0275prov=ue({token:i,factory:i.\u0275fac})}return i})();var ce=(()=>{class i extends Ee{styleClass;style;strokeWidth="2";fill="none";animationDuration="2s";ariaLabel;_componentStyle=g(qe);static \u0275fac=(()=>{let t;return function(o){return(t||(t=ne(i)))(o||i)}})();static \u0275cmp=u({type:i,selectors:[["p-progressSpinner"],["p-progress-spinner"],["p-progressspinner"]],inputs:{styleClass:"styleClass",style:"style",strokeWidth:"strokeWidth",fill:"fill",animationDuration:"animationDuration",ariaLabel:"ariaLabel"},features:[Te([qe]),be],decls:3,vars:11,consts:[["role","progressbar",1,"p-progressspinner",3,"ngStyle","ngClass"],["viewBox","25 25 50 50",1,"p-progressspinner-spin"],["cx","50","cy","50","r","20","stroke-miterlimit","10",1,"p-progressspinner-circle"]],template:function(n,o){n&1&&(r(0,"div",0),he(),r(1,"svg",1),d(2,"circle",2),s()()),n&2&&(a("ngStyle",o.style)("ngClass",o.styleClass),k("aria-label",o.ariaLabel)("aria-busy",!0)("data-pc-name","progressspinner")("data-pc-section","root"),l(),ye("animation-duration",o.animationDuration),k("data-pc-section","root"),l(),k("fill",o.fill)("stroke-width",o.strokeWidth))},dependencies:[_,ke,Be,z],encapsulation:2,changeDetection:0})}return i})(),Ke=(()=>{class i{static \u0275fac=function(n){return new(n||i)};static \u0275mod=ve({type:i});static \u0275inj=fe({imports:[ce,z,z]})}return i})();function lt(i,e){if(i&1){let t=x();r(0,"button",2),b(1,"translate"),b(2,"translate"),f("click",function(o){p(t);let v=h();return c(v.onDelete(o))}),d(3,"i",3),s()}i&2&&(a("title",y(1,2,"chat.deleteMessage")),k("aria-label",y(2,4,"chat.deleteMessage")))}function pt(i,e){i&1&&d(0,"p-progressSpinner",4),i&2&&a("styleClass","message-spinner")("strokeWidth","3")("animationDuration","1s")("ariaLabel","Loading")}var te=class i{message;currentUserId;deleteMessage=new Ce;onDelete(e){this.deleteMessage.emit({event:e,message:this.message})}static \u0275fac=function(t){return new(t||i)};static \u0275cmp=u({type:i,selectors:[["app-message-delete-button"]],inputs:{message:"message",currentUserId:"currentUserId"},outputs:{deleteMessage:"deleteMessage"},decls:2,vars:2,consts:[["type","button","class","delete-icon-btn","pButton","","pRipple","",3,"title","click",4,"ngIf"],[3,"styleClass","strokeWidth","animationDuration","ariaLabel",4,"ngIf"],["type","button","pButton","","pRipple","",1,"delete-icon-btn",3,"click","title"],["aria-hidden","true",1,"pi","pi-trash"],[3,"styleClass","strokeWidth","animationDuration","ariaLabel"]],template:function(t,n){t&1&&M(0,lt,4,6,"button",0)(1,pt,1,4,"p-progressSpinner",1),t&2&&(a("ngIf",n.message.sender.id===n.currentUserId&&n.message.id),l(),a("ngIf",!n.message.id))},dependencies:[_,w,U,Y,B,Q,Ke,ce,P,T],styles:["[_nghost-%COMP%]{position:absolute;right:2px;top:0}.delete-icon-btn[_ngcontent-%COMP%]{width:24px;height:24px;min-width:24px;padding:0;align-items:center;justify-content:center;background:transparent!important;border:none!important;box-shadow:none!important;transition:all .2s ease;display:none;cursor:pointer;border-radius:50%}.delete-icon-btn[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{font-size:18px;color:#fff9;transition:all .2s ease}.delete-icon-btn[_ngcontent-%COMP%]:hover   i[_ngcontent-%COMP%]{color:#34f5f5}.delete-icon-btn[_ngcontent-%COMP%]:active{transform:scale(.95)}.delete-icon-btn[_ngcontent-%COMP%]:focus{outline:2px solid #34f5f5;outline-offset:2px}  .message-spinner{width:24px!important;height:24px!important;display:none!important}  .message-spinner svg{width:24px;height:24px}  .message-spinner circle{stroke:#34f5f5!important}"]})};function ct(i,e){if(i&1){let t=x();r(0,"button",1),f("click",function(){p(t);let o=h();return c(o.onScrollClick())}),d(1,"i",2),s()}}var ie=class i{visible=I(!1);scrollToBottom=H();onScrollClick(){this.scrollToBottom.emit()}static \u0275fac=function(t){return new(t||i)};static \u0275cmp=u({type:i,selectors:[["app-scroll-to-bottom-button"]],inputs:{visible:[1,"visible"]},outputs:{scrollToBottom:"scrollToBottom"},decls:1,vars:1,consts:[["type","button","pButton","","pRipple","","class","p-button p-button-secondary scroll-to-bottom-btn","title","Scroll to bottom","aria-label","Scroll to newest messages",3,"click",4,"ngIf"],["type","button","pButton","","pRipple","","title","Scroll to bottom","aria-label","Scroll to newest messages",1,"p-button","p-button-secondary","scroll-to-bottom-btn",3,"click"],["aria-hidden","true",1,"pi","pi-chevron-down"]],template:function(t,n){t&1&&M(0,ct,2,0,"button",0),t&2&&a("ngIf",n.visible())},dependencies:[_,w,U,Y,B,Q],styles:[".scroll-to-bottom-btn[_ngcontent-%COMP%]{position:absolute;bottom:104px;right:18px;width:44px;height:44px;padding:0;border-radius:333px;display:flex;align-items:center;justify-content:center;z-index:10;animation:_ngcontent-%COMP%_fadeInUp .25s ease-out;background:#000c!important;border:1px solid #ffffff!important;color:#fff!important}.scroll-to-bottom-btn[_ngcontent-%COMP%]   i[_ngcontent-%COMP%]{font-size:18px}.scroll-to-bottom-btn[_ngcontent-%COMP%]:hover{border-color:#fff!important;color:#fff!important;transform:translateY(-2px);box-shadow:0 6px 16px #ffffff40}.scroll-to-bottom-btn[_ngcontent-%COMP%]:active{transform:translateY(0) scale(.97);box-shadow:none}@keyframes _ngcontent-%COMP%_fadeInUp{0%{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}"]})};var mt=["messagesContainer"],dt=["messageInput"],gt=()=>({width:"600px",maxWidth:"95vw"});function ut(i,e){i&1&&(r(0,"div",3),d(1,"app-loader"),s())}function ft(i,e){if(i&1){let t=x();r(0,"div",13)(1,"div")(2,"div",14),S(3),s(),r(4,"div",15)(5,"app-message-delete-button",16),f("deleteMessage",function(o){p(t);let v=h(2);return c(v.onDeleteMessage(o.event,o.message))}),s(),r(6,"small"),S(7),s()()()()}if(i&2){let t=e.$implicit,n=h(2);l(),_e("sender",t.sender.id===n.currentUserId())("receiver",t.sender.id!==n.currentUserId()),l(2),oe(" ",t.content," "),l(2),a("message",t)("currentUserId",n.currentUserId()),l(2),oe(" ",n.formatMessageTime(t.timestamp)," ")}}function ht(i,e){if(i&1){let t=x();r(0,"div",17)(1,"p-button",18),b(2,"translate"),f("onClick",function(){p(t);let o=h(2);return c(o.showDeleteConfirmDialog=!1)}),s(),r(3,"p-button",19),b(4,"translate"),f("onClick",function(){p(t);let o=h(2);return c(o.confirmDeleteMessage())}),s()()}i&2&&(l(),a("label",y(2,2,"Cancel")),l(2),a("label",y(4,4,"chat.deleteConfirmation.accept")))}function Ct(i,e){if(i&1){let t=x();d(0,"app-chat-header",4),r(1,"div",5,0),f("scroll",function(){p(t);let o=h();return c(o.onScroll())}),d(3,"div",6),M(4,ft,8,8,"div",7),s(),r(5,"p-dialog",8),b(6,"translate"),we("visibleChange",function(o){p(t);let v=h();return Se(v.showDeleteConfirmDialog,o)||(v.showDeleteConfirmDialog=o),c(o)}),r(7,"p",9),S(8),b(9,"translate"),s(),M(10,ht,5,6,"ng-template",10),s(),r(11,"app-message-input",11),f("messageSent",function(o){p(t);let v=h();return c(v.handleMessageSent(o))}),s(),r(12,"app-scroll-to-bottom-button",12),f("scrollToBottom",function(){p(t);let o=h();return c(o.scrollToBottomManual())}),s()}if(i&2){let t=h();a("interlocutorProfile",t.interlocutorProfile())("isOnline",t.isOnline())("isTyping",t.getTypingIndicatorVisible()),l(4),a("ngForOf",t.messages)("ngForTrackBy",t.trackByMessageId),l(),Me(Pe(23,gt)),Ie("visible",t.showDeleteConfirmDialog),a("header",y(6,19,"chat.deleteConfirmation.header"))("modal",!0)("closable",!0)("draggable",!1)("resizable",!1)("closeOnEscape",!0)("appendTo","body"),l(3),D(y(9,21,"chat.deleteConfirmation.message")),l(3),a("activeChatId",t.activeChatId())("receiverId",t.receiverId),l(),a("visible",t.showScrollToBottom())}}var Ge=class i{chatService=g(J);route=g(Re);stateService=g(A);chatStateService=g($);destroy$=new ge;authTokenStateService=g(Ne);token=C(()=>this.authTokenStateService.token());interlocutorService=g(K);currentUserId=C(()=>this.stateService.userId()||"");interlocutor=C(()=>this.interlocutorService.interlocutor()||null);isOnline=C(()=>this.interlocutor()?.isOnline||!1);interlocutorProfile=C(()=>this.interlocutor()?.profile?de(me({},this.interlocutor()?.profile),{avatarUrl:this.interlocutor()?.avatarUrl}):null);receiverId="";messagesContainer;messageInput;messages=[];isLoading=O(!1);showScrollToBottom=O(!1);activeChatId=O("");typingUsers=O([]);showDeleteConfirmDialog=!1;messageToDelete=null;messageSubscription;previousMessagesSubscription;shouldScrollToBottom=!1;scrollTimeout=null;isUserScrolling=!1;constructor(){Oe(()=>{let e=this.token();e&&this.chatService.connect(e)})}ngOnInit(){this.route.paramMap.subscribe(e=>{this.receiverId=e.get("receiverId")||"",this.receiverId&&(this.isLoading.set(!0),this.chatService.isConnected()?this.startChatRoom():this.chatService.onConnect().pipe(j(this.destroy$)).subscribe(()=>{this.startChatRoom()}))})}startChatRoom(){this.joinChatRoom(),this.subscribeToMessages(),this.setupEnhancedSocketListeners()}setupEnhancedSocketListeners(){this.chatService.onUserTyping().pipe(j(this.destroy$)).subscribe(e=>{e.chatId===this.activeChatId()&&this.updateTypingUsers(e)}),this.chatService.onMessageRemoved().pipe(j(this.destroy$)).subscribe(e=>{e.chatId===this.activeChatId()&&this.removeMessageFromUI(e.messageId)})}updateTypingUsers(e){let t=this.typingUsers();e.isTyping?t.find(n=>n.userId===e.userId)||this.typingUsers.set([...t,e]):this.typingUsers.set(t.filter(n=>n.userId!==e.userId))}getTypingIndicatorVisible(){return this.typingUsers().length>0&&!this.typingUsers().some(e=>e.userId===this.currentUserId())}ngAfterViewChecked(){this.shouldScrollToBottom&&!this.isUserScrolling&&(this.scrollToBottomSmooth(),this.shouldScrollToBottom=!1)}scrollToBottomSmooth(){try{if(this.messagesContainer?.nativeElement){let e=this.messagesContainer.nativeElement;e.scrollTo({top:e.scrollHeight,behavior:"smooth"})}}catch(e){console.warn("Could not scroll to bottom:",e)}}scrollToBottom(){try{if(this.messagesContainer?.nativeElement){let e=this.messagesContainer.nativeElement;e.scrollTop=e.scrollHeight}}catch(e){console.warn("Could not scroll to bottom:",e)}}isNearBottom(){if(!this.messagesContainer?.nativeElement)return!1;let e=this.messagesContainer.nativeElement;return e.scrollTop+e.clientHeight>=e.scrollHeight-100}onScroll(){this.isUserScrolling=!0,this.scrollTimeout&&clearTimeout(this.scrollTimeout);let e=this.isNearBottom();this.showScrollToBottom.set(!e),this.scrollTimeout=setTimeout(()=>{this.isUserScrolling=!1,e&&(this.shouldScrollToBottom=!0)},150)}subscribeToMessages(){this.messageSubscription=this.chatService.onReceiveMessage().subscribe(e=>{let t=this.isNearBottom();console.log("Received message:",e),e.sender.id!==this.currentUserId()?(this.messages=[...this.messages,e],this.updateChatUnreadCount()):this.messages=this.messages.map(n=>n.muid===e.muid?e:n),(t||e.sender.id===this.currentUserId())&&(this.shouldScrollToBottom=!0)})}handleMessageSent(e){this.messages.push(e),this.shouldScrollToBottom=!0}ngOnDestroy(){this.scrollTimeout&&clearTimeout(this.scrollTimeout),this.messageSubscription&&this.messageSubscription.unsubscribe(),this.previousMessagesSubscription&&this.previousMessagesSubscription.unsubscribe(),this.destroy$.next(),this.destroy$.complete(),this.activeChatId()&&this.chatService.leaveChat(this.activeChatId())}joinChatRoom(){this.chatService.joinChat(Number(this.currentUserId()),Number(this.receiverId)).subscribe(e=>{console.log(`Joined chat with ID: ${e}`),this.activeChatId.set(e)}),this.previousMessagesSubscription=this.chatService.onPreviousMessages().subscribe(({messages:e,chat:t})=>{let n=t.participant1?.id===this.currentUserId()?t.participant2:t.participant1;n&&this.interlocutorService.interlocutor.set(n),console.log("Joined chat room:",t),this.messages=e,this.isLoading.set(!1),this.activeChatId.set(t.id),setTimeout(()=>{this.scrollToBottom(),this.showScrollToBottom.set(!1)},100)})}updateChatUnreadCount(){this.activeChatId()&&this.chatStateService.markChatAsRead(this.activeChatId())}formatMessageTime(e){if(!e)return"";let t=typeof e=="string"?new Date(e):e;return Math.abs(new Date().getTime()-t.getTime())/(1e3*60*60)<24?t.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}):t.toLocaleDateString([],{month:"short",day:"numeric"})}trackByMessageId(e,t){return t.id||e}scrollToBottomManual(){this.isUserScrolling=!1,this.shouldScrollToBottom=!0,this.scrollToBottomSmooth()}removeMessageFromUI(e){this.messages=this.messages.filter(t=>String(t.muid)!==String(e))}onDeleteMessage(e,t){console.log("Delete message requested:",t.sender.id!==this.currentUserId()),e.stopPropagation(),t.sender.id===this.currentUserId()&&(this.messageToDelete=t,this.showDeleteConfirmDialog=!0)}confirmDeleteMessage(){this.messageToDelete&&(this.deleteMessage(this.messageToDelete),this.showDeleteConfirmDialog=!1,this.messageToDelete=null)}deleteMessage(e){this.chatService.removeMessage(e.muid),this.removeMessageFromUI(e.muid)}static \u0275fac=function(t){return new(t||i)};static \u0275cmp=u({type:i,selectors:[["app-chat"]],viewQuery:function(t,n){if(t&1&&(R(mt,5),R(dt,5)),t&2){let o;N(o=F())&&(n.messagesContainer=o.first),N(o=F())&&(n.messageInput=o.first)}},inputs:{receiverId:"receiverId"},decls:3,vars:2,consts:[["messagesContainer",""],[1,"chat-container"],["class","loader-container",4,"ngIf"],[1,"loader-container"],[3,"interlocutorProfile","isOnline","isTyping"],[1,"messages",3,"scroll"],[1,"ghost-message"],["class","message",4,"ngFor","ngForOf","ngForTrackBy"],[3,"visibleChange","visible","header","modal","closable","draggable","resizable","closeOnEscape","appendTo"],[1,"dialog-text"],["pTemplate","footer"],[3,"messageSent","activeChatId","receiverId"],[3,"scrollToBottom","visible"],[1,"message"],[1,"message-content"],[1,"message-meta"],[3,"deleteMessage","message","currentUserId"],[1,"dialog-footer"],["icon","pi pi-times","severity","secondary",3,"onClick","label"],["icon","pi pi-upload","severity","success",3,"onClick","label"]],template:function(t,n){t&1&&(r(0,"div",1),M(1,ut,2,0,"div",2)(2,Ct,13,24),s()),t&2&&(l(),a("ngIf",!n.interlocutorProfile()||n.isLoading()),l(),xe(n.interlocutorProfile()&&!n.isLoading()?2:-1))},dependencies:[_,De,w,W,$e,Z,P,T,ee,Ae,ze,Ue,U,q,B,te,ie],styles:['.receiver[_ngcontent-%COMP%]{background:radial-gradient(circle at 20% 30%,rgba(52,245,245,.5) 0%,transparent 122%),radial-gradient(circle at 80% 20%,rgba(52,211,245,.4) 0%,transparent 60%),radial-gradient(circle at 60% 80%,rgba(45,212,245,.4) 0%,transparent 55%),radial-gradient(circle at 30% 60%,rgba(16,185,245,.3) 0%,transparent 45%),linear-gradient(135deg,#18181b4d,#1a1a1d33,#1212144d,#1a1a1d33,#18181b4d);border:1px solid rgba(52,245,221,.1);box-shadow:0 8px 8px #0000004d}.sender[_ngcontent-%COMP%]{background:radial-gradient(circle at 20% 30%,rgba(52,245,221,.5) 0%,transparent 122%),radial-gradient(circle at 80% 20%,rgba(52,211,204,.4) 0%,transparent 60%),radial-gradient(circle at 60% 80%,rgba(45,212,191,.4) 0%,transparent 55%),radial-gradient(circle at 30% 60%,rgba(16,185,129,.3) 0%,transparent 45%),linear-gradient(135deg,#18181b4d,#1a1a1d33,#1212144d,#1a1a1d33,#18181b4d);border:1px solid rgba(52,245,221,.1);box-shadow:0 8px 8px #0000004d}.messages[_ngcontent-%COMP%]::-webkit-scrollbar{width:6px}.messages[_ngcontent-%COMP%]::-webkit-scrollbar-track{background:#ffffff1a;border-radius:3px}.messages[_ngcontent-%COMP%]::-webkit-scrollbar-thumb{background:#ffffff4d;border-radius:3px}.messages[_ngcontent-%COMP%]::-webkit-scrollbar-thumb:hover{background:#ffffff80}[_nghost-%COMP%]{display:flex;justify-content:flex-end;width:100%;padding:55px 10px 10px;height:100%}.chat-container[_ngcontent-%COMP%]{width:100%;max-width:400px;border:1px solid rgba(52,245,221,.1);border-radius:8px;display:flex;flex-direction:column;height:100%;overflow:hidden}.chat-container[_ngcontent-%COMP%]   .loader-container[_ngcontent-%COMP%]{display:flex;justify-content:center;align-items:center;width:100%;height:100%}.dialog-text[_ngcontent-%COMP%]{text-align:center}.messages[_ngcontent-%COMP%]{flex:1;padding:15px;overflow-y:auto;overflow-x:hidden;background:#18181b6b;scroll-behavior:auto;position:relative}.messages[_ngcontent-%COMP%]   .ghost-message[_ngcontent-%COMP%]{height:100dvh}.message[_ngcontent-%COMP%]{margin-bottom:12px;display:flex;color:#000;font-size:16px;font-weight:400}.message[_ngcontent-%COMP%]:last-child{margin-bottom:0}.message[_ngcontent-%COMP%]   div[_ngcontent-%COMP%]{padding:6px 8px 0 6px;border-radius:18px;word-wrap:break-word;position:relative}.sender[_ngcontent-%COMP%]{display:flex;flex-direction:column;align-items:flex-end;align-self:flex-end;margin-left:auto;border-bottom-right-radius:6px}.sender[_ngcontent-%COMP%]:after{content:"";position:absolute;bottom:-3px;right:-4px;width:0;height:0;border:8px solid transparent;border-bottom-color:#44f8c6;border-right:none;border-bottom-right-radius:6px}.sender[_ngcontent-%COMP%]   .message-meta[_ngcontent-%COMP%]{display:flex;justify-content:flex-end}.receiver[_ngcontent-%COMP%]{align-self:flex-start;margin-right:auto;border-bottom-left-radius:6px}.receiver[_ngcontent-%COMP%]:before{content:"";position:absolute;bottom:-3px;left:-4px;width:0;height:0;border:8px solid transparent;border-bottom-color:#44c6d7;border-left:none;border-bottom-left-radius:6px}.receiver[_ngcontent-%COMP%]   .message-meta[_ngcontent-%COMP%]{display:flex;justify-content:flex-start}.message-content[_ngcontent-%COMP%]{max-width:240px;margin-bottom:4px;word-wrap:break-word}.message-meta[_ngcontent-%COMP%]{width:auto;min-width:72px;min-height:25px;margin-bottom:4px;border:none!important;box-shadow:none!important;padding:0 8px 10px!important;display:flex;align-items:center;justify-content:space-between;gap:8px}.message-meta[_ngcontent-%COMP%]   small[_ngcontent-%COMP%]{position:relative;font-size:12px!important;color:#ffffffb3;opacity:.8}.message[_ngcontent-%COMP%]   .sender[_ngcontent-%COMP%]:hover   .message-meta[_ngcontent-%COMP%]   small[_ngcontent-%COMP%]{display:none}.message[_ngcontent-%COMP%]   .sender[_ngcontent-%COMP%]:hover   .message-meta[_ngcontent-%COMP%]   app-message-delete-button[_ngcontent-%COMP%]     .delete-icon-btn{display:flex}.message[_ngcontent-%COMP%]   .sender[_ngcontent-%COMP%]:hover   .message-meta[_ngcontent-%COMP%]   app-message-delete-button[_ngcontent-%COMP%]     .message-spinner{display:block!important}@media (max-width: 768px){[_nghost-%COMP%]{padding:50px 5px 5px;justify-content:center}.chat-container[_ngcontent-%COMP%]{max-width:99vw}}']})};export{Ge as ChatComponent};
